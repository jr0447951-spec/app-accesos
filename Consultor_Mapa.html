<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultor de Sitio - Network Ops</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #00a1ff; 
            --dark-bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --success: #22c55e;
            --warning: #fbbf24;
            --danger: #ef4444;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding-bottom: 100px; 
            background: radial-gradient(circle at top right, #1e293b, var(--dark-bg));
            color: white; min-height: 100vh;
        }

        header { 
            width: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
            padding: 15px 0; position: sticky; top: 0; z-index: 2000;
            border-bottom: 1px solid var(--border); text-align: center;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            font-size: 1.2rem;
            letter-spacing: 2px;
            background: linear-gradient(to bottom, #ffffff, #00a1ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            filter: drop-shadow(0 0 8px rgba(0, 161, 255, 0.5));
        }
        
        #status-indicator {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            margin-top: 5px; opacity: 0.8;
            font-family: 'Orbitron', sans-serif;
        }

        .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
        .dot-sync { background: var(--warning); animation: pulse 1s infinite; }
        .dot-ready { background: var(--success); }
        .dot-error { background: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .search-area { width: 92%; max-width: 500px; margin: 20px auto; position: relative; }
        #siteSearch { 
            width: 100%; padding: 16px 45px 16px 18px; font-size: 1rem; border-radius: 14px; 
            border: 1px solid var(--border); background: rgba(255,255,255,0.05);
            color: white; outline: none; box-sizing: border-box;
        }
        #clearBtn {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.15); border: none; color: white;
            width: 28px; height: 28px; border-radius: 50%; display: none; cursor: pointer;
        }

        .suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: #1e293b; border-radius: 12px; max-height: 250px; 
            overflow-y: auto; z-index: 3000; display: none; margin-top: 5px; border: 1px solid var(--primary);
        }
        .suggestion-item { padding: 14px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .suggestion-item:hover { background: rgba(0, 161, 255, 0.1); }

        #result { width: 92%; max-width: 500px; margin: 0 auto; scroll-margin-top: 100px; }
        
        .card { 
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 24px; padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: fadeIn 0.3s ease-out;
        }

        .header-title { 
            background: rgba(0, 161, 255, 0.15); padding: 18px; border-radius: 16px; 
            text-align: center; margin-bottom: 15px; border: 1px dashed var(--primary); cursor: pointer;
        }
        .header-title h2 { margin: 0; font-size: 1rem; text-transform: uppercase; font-family: 'Orbitron', sans-serif; }
        .copy-tag { font-size: 0.6rem; color: var(--primary); font-weight: bold; margin-top: 6px; display: block; }

        .map-box { 
            width: 100%; height: 200px; border-radius: 16px; overflow: hidden; 
            margin-bottom: 20px; border: 1px solid var(--border); background: #000;
        }

        .info-list { display: flex; flex-direction: column; gap: 10px; }
        .info-item { background: rgba(255,255,255,0.03); padding: 10px 14px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .info-label { font-size: 0.6rem; color: var(--primary); font-weight: 800; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .info-val { font-size: 1rem; color: #fff; font-weight: 500; }
        
        .key-alert { 
            background: #be123c; border-left: 4px solid #ff4d4d; color: white; 
            padding: 12px; border-radius: 12px; font-weight: bold; display: flex; 
            flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 10px; font-size: 0.85rem;
        }

        .btn-gps { 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: linear-gradient(135deg, var(--primary), #0072ff); color: white; 
            padding: 18px; border-radius: 16px; text-decoration: none; font-weight: 800; margin-top: 25px;
            font-family: 'Orbitron', sans-serif; font-size: 0.9rem;
        }

        .btn-home {
            position: fixed; bottom: 30px; right: 25px;
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(0, 161, 255, 0.1); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px rgba(0, 161, 255, 0.4), inset 0 0 10px rgba(0, 161, 255, 0.2);
            color: white; cursor: pointer; z-index: 5000; display: flex;
            align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-home svg { width: 28px; height: 28px; fill: white; filter: drop-shadow(0 0 5px var(--primary)); }
        .btn-home:active { transform: scale(0.85); box-shadow: 0 0 25px var(--primary); }

        .btn-copy-small {
            background: none; border: none; cursor: pointer; padding: 0; 
            font-size: 1.1rem; opacity: 0.8; transition: opacity 0.2s;
        }
        .btn-copy-small:hover { opacity: 1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <h1>CONSULTOR DE SITIO</h1>
    <div id="status-indicator">
        <span id="status-dot" class="dot dot-sync"></span>
        <span id="status-text">Sincronizando...</span>
    </div>
</header>

<div class="search-area">
    <input type="text" id="siteSearch" placeholder="üîç ID o Nombre del sitio..." autocomplete="off">
    <button id="clearBtn" onclick="limpiar()">‚úï</button>
    <div id="suggestions" class="suggestions"></div>
</div>

<div id="result"></div>

<button class="btn-home" onclick="goHome()" title="Volver al inicio">
    <svg viewBox="0 0 24 24">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
</button>

<script>
// Forzar el scroll al inicio al cargar la p√°gina
window.onbeforeunload = function () { window.scrollTo(0, 0); };
if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; }

let sites = [];
const input = document.getElementById('siteSearch');
const clearBtn = document.getElementById('clearBtn');
const sugDiv = document.getElementById('suggestions');
const resultDiv = document.getElementById('result');
const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');

const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv';

function procesarCSV(data) {
    const rows = data.split(/\r?\n/).filter(row => row.trim().length > 0);
    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
    return rows.slice(1).map(row => {
        const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim().replace(/"/g, '') : '');
        return obj;
    });
}

fetch(SHEETS_CSV_URL)
    .then(r => { if (!r.ok) throw new Error(); return r.text(); })
    .then(data => {
        sites = procesarCSV(data);
        localStorage.setItem('sites_cache', JSON.stringify(sites));
        statusDot.className = "dot dot-ready";
        statusText.innerText = `Red Lista: ${sites.length} Sitios`;
        statusText.style.color = "var(--success)";
    })
    .catch(err => {
        const cachedData = localStorage.getItem('sites_cache');
        if (cachedData) {
            sites = JSON.parse(cachedData);
            statusDot.className = "dot dot-ready";
            statusText.innerText = `Modo Offline: ${sites.length} Sitios`;
            statusText.style.color = "var(--warning)";
        } else {
            statusDot.className = "dot dot-error";
            statusText.innerText = "Error de Red";
            statusText.style.color = "var(--danger)";
        }
    });

input.addEventListener('input', (e) => {
    const val = e.target.value.toLowerCase().trim();
    clearBtn.style.display = val.length > 0 ? 'flex' : 'none';
    if (val.length < 2) { sugDiv.style.display = 'none'; return; }
    const matches = sites.filter(s => (s.SITEID && s.SITEID.toLowerCase().includes(val)) || (s['NOMBRE DE SITIO'] && s['NOMBRE DE SITIO'].toLowerCase().includes(val))).slice(0, 8);
    sugDiv.innerHTML = matches.map(s => `<div class="suggestion-item" onclick="seleccionar('${s.SITEID}')"><strong>${s.SITEID}</strong><br><small>${s['NOMBRE DE SITIO']}</small></div>`).join('');
    sugDiv.style.display = matches.length ? 'block' : 'none';
});

function limpiar() { input.value = ''; clearBtn.style.display = 'none'; sugDiv.style.display = 'none'; resultDiv.innerHTML = ''; window.scrollTo({top: 0, behavior: 'smooth'});}

function goHome() { if (navigator.vibrate) navigator.vibrate(20); window.scrollTo({top: 0, behavior: 'smooth'}); setTimeout(()=> {location.reload();}, 300); }

function seleccionar(id) {
    const s = sites.find(x => x.SITEID === id);
    sugDiv.style.display = 'none';
    input.value = s['NOMBRE DE SITIO'];
    
    const rawLlave = (s['Llave requerida'] || s['LLAVE REQUERIDA'] || "").trim();
    const infoLlave = (s['Informaci√≥n de llave'] || s['INFORMACION DE LLAVE'] || "").trim();
    let llaveHTML = '';
    if (rawLlave.toUpperCase().startsWith("SI")) {
        llaveHTML = `
            <div class="key-alert">
                <span>üîë LLAVE NECESARIA</span>
                <span style="font-size:0.75rem; font-weight:normal;">${rawLlave}</span>
                ${infoLlave ? `<span style="font-size:0.72rem; font-weight:800; margin-top:5px; border-top:1px solid rgba(255,255,255,0.2); width:100%; padding-top:5px;">‚ÑπÔ∏è INFO: ${infoLlave}</span>` : ''}
            </div>`;
    }

    const mapUrl = `https://maps.google.com/maps?q=${s.LATITUDE},${s.LONGITUDE}&t=k&z=18&output=embed`;

    resultDiv.innerHTML = `
        <div class="card">
            <div class="header-title" onclick="copiar('${s.SITEID} - ${s['NOMBRE DE SITIO']}', 'ID')">
                <h2>${s.SITEID} - ${s['NOMBRE DE SITIO']}</h2>
                <span id="copyLabel" class="copy-tag">TAP PARA COPIAR ID</span>
            </div>
            <div class="map-box">
                <iframe width="100%" height="100%" frameborder="0" src="${mapUrl}"></iframe>
            </div>
            <div class="info-list">
                <div class="info-item"><span class="info-label">NIC / NIS</span><span class="info-val" style="color:#fbbf24;">${s['NIC/NIS'] || 'N/A'}</span></div>
                <div class="info-item"><span class="info-label">Distribuidora</span><span class="info-val">${s.Distribuidora || 'N/A'}</span></div>
                ${llaveHTML}
                <div class="info-item"><span class="info-label">Porte</span><span class="info-val">${s.Porte || 'N/A'}</span></div>
                <div class="info-item"><span class="info-label">Altura</span><span class="info-val">${s.Altura || 'N/A'}</span></div>
                
                <div class="info-item"><span class="info-label">Propietario</span><span class="info-val">${s.Propietario || 'N/A'}</span></div>
                
                <div class="info-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span class="info-label">Nombre para Propietario</span>
                        <span class="info-val">${s['Nombre para Propietario'] || 'N/A'}</span>
                    </div>
                    <button class="btn-copy-small" onclick="copiar('${s['Nombre para Propietario']}', 'PROP', this)">üìã</button>
                </div>

                <div class="info-item"><span class="info-label">Tipo de Transmisi√≥n</span><span class="info-val">${s['Tipo de Transmisi√≥n'] || 'N/A'}</span></div>
                
                <div class="info-item"><span class="info-label">Municipio</span><span class="info-val">${s.Municipio || 'N/A'}</span></div>
                <div class="info-item"><span class="info-label">Direcci√≥n Exacta</span><span class="info-val">${s.DIRECCION || s['Direcci√≥n'] || 'N/A'}</span></div>
            </div>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${s.LATITUDE},${s.LONGITUDE}" target="_blank" class="btn-gps">üöÄ INICIAR GPS</a>
        </div>
    `;
    setTimeout(() => { resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 150);
}

function copiar(txt, tipo, el) {
    if (!txt || txt === 'N/A') return;
    navigator.clipboard.writeText(txt);
    if (navigator.vibrate) navigator.vibrate(20);

    if (tipo === 'ID') {
        const lbl = document.getElementById('copyLabel');
        lbl.innerText = "¬°DATOS COPIADOS!"; lbl.style.color = "var(--success)";
        setTimeout(() => { lbl.innerText = "TAP PARA COPIAR ID"; lbl.style.color = "var(--primary)"; }, 1500);
    } else {
        const original = el.innerText;
        el.innerText = "‚úÖ";
        setTimeout(() => { el.innerText = original; }, 1000);
    }
}

document.addEventListener('click', (e) => { if (!input.contains(e.target)) sugDiv.style.display = 'none'; });

// Asegurar inicio al cargar
window.scrollTo(0, 0);
</script>
</body>
</html>
