<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consultor Mapa</title>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f1f5f9;
    margin:0; padding:0;
    display:flex; flex-direction:column; align-items:center;
    color: #334155;
  }
  h1 { text-align:center; color:#1e3a8a; margin:20px 0 5px; font-size: 1.5rem; }
  .loading-status { font-size: 0.8rem; margin-bottom: 15px; color: #64748b; }
  
  /* Contenedor del buscador con posici√≥n relativa */
  .search-container {
    width:90%;
    max-width:500px;
    margin-bottom:20px;
    position:relative;
  }

  input[type="text"] {
    width:100%;
    padding:12px 40px 12px 16px; /* Espacio a la derecha para la X */
    font-size:1rem;
    border-radius:12px;
    border:2px solid #cbd5e1;
    box-sizing: border-box;
    outline: none;
    transition: border 0.3s;
  }
  input[type="text"]:focus { border-color: #3b82f6; }

  /* Bot√≥n de limpiar sutil */
  .clear-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: #cbd5e1;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: none; /* Oculto por defecto */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: background 0.2s;
    user-select: none;
  }
  .clear-btn:hover { background: #94a3b8; }

  .suggestions {
    position:absolute;
    top:105%; left:0; right:0;
    background:white;
    border-radius:12px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    max-height:250px;
    overflow-y:auto;
    z-index: 100;
  }
  .suggestion-item { padding:12px 16px; cursor:pointer; border-bottom: 1px solid #f1f5f9; }
  .suggestion-item:hover { background:#eff6ff; }

  .card {
    background:white;
    border-radius:20px;
    box-shadow:0 10px 25px rgba(0,0,0,0.05);
    width:90%;
    max-width:500px;
    margin-bottom:30px;
    padding:20px;
    animation: fadeIn 0.4s ease-out;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .map-preview iframe {
    width:100%; height:200px;
    border-radius:12px; border:none;
    background: #e2e8f0;
  }
  .distance {
    background:#dbeafe; color:#1e40af;
    padding:10px; border-radius:10px;
    text-align:center; font-weight:bold; margin: 15px 0;
  }
  .data-table { width:100%; border-collapse:collapse; }
  .data-table td { padding:8px; border-bottom:1px solid #f1f5f9; font-size: 0.9rem; }
  .label { font-weight:600; color:#64748b; width:45%; }
  
  .go-button {
    display:block; text-align:center;
    background:#2563eb; color:white;
    padding:14px; border-radius:12px;
    text-decoration:none; font-weight:bold;
    margin-top:20px;
  }
</style>
</head>
<body>

<h1>Consultor de Sitios</h1>
<div id="status" class="loading-status">Conectando con base de datos...</div>

<div class="search-container">
  <input type="text" id="siteSearch" placeholder="Busca por Nombre o ID..." disabled>
  <div id="clearSearch" class="clear-btn">‚úï</div>
  <div id="suggestions" class="suggestions"></div>
</div>

<div id="result"></div>

<script>
let sites = [];
let userPosition = null;

const input = document.getElementById('siteSearch');
const suggestions = document.getElementById('suggestions');
const statusDiv = document.getElementById('status');
const clearBtn = document.getElementById('clearSearch');

// 1. CARGA DE DATOS
fetch('https://raw.githubusercontent.com/tu_usuario/tu_repo/main/Mapa_Base.csv')
  .then(res => res.text())
  .then(data => {
    const lines = data.split(/\r?\n/).filter(line => line.trim() !== '');
    const headers = lines[0].split(';').map(h => h.trim());
    
    sites = lines.slice(1).map(line => {
      const values = line.split(';');
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = values[i] ? values[i].trim() : '';
      });
      return obj;
    });
    statusDiv.innerHTML = `‚úÖ <strong>${sites.length}</strong> sitios cargados.`;
    input.disabled = false;
  })
  .catch(() => { statusDiv.innerHTML = "‚ùå Error de conexi√≥n."; });

// 2. GEOLOCALIZACI√ìN
if(navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    userPosition = {lat: pos.coords.latitude, lon: pos.coords.longitude};
  });
}

// 3. L√ìGICA DEL BUSCADOR Y BOT√ìN LIMPIAR
input.addEventListener('input', () => {
  const query = input.value.toLowerCase().trim();
  suggestions.innerHTML = '';
  
  // Mostrar/Ocultar bot√≥n X
  clearBtn.style.display = query.length > 0 ? 'flex' : 'none';

  if (query.length > 1) {
    const filtered = sites.filter(s => 
      (s['NOMBRE DE SITIO'] && s['NOMBRE DE SITIO'].toLowerCase().includes(query)) ||
      (s['SITEID'] && s['SITEID'].toLowerCase().includes(query))
    ).slice(0, 8);

    filtered.forEach(s => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.innerHTML = `<strong>${s['SITEID']}</strong> - ${s['NOMBRE DE SITIO']}`;
      div.onclick = () => selectSite(s);
      suggestions.appendChild(div);
    });
  }
});

// Funci√≥n del bot√≥n limpiar
clearBtn.onclick = () => {
  input.value = '';
  suggestions.innerHTML = '';
  document.getElementById('result').innerHTML = '';
  clearBtn.style.display = 'none';
  input.focus();
};

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function selectSite(d) {
  suggestions.innerHTML = '';
  input.value = d['NOMBRE DE SITIO'];
  clearBtn.style.display = 'flex';
  
  const lat = parseFloat(String(d.LATITUDE).replace(',', '.'));
  const lon = parseFloat(String(d.LONGITUDE).replace(',', '.'));

  let distBox = '';
  if (userPosition && !isNaN(lat)) {
    const dist = getDistance(userPosition.lat, userPosition.lon, lat, lon);
    distBox = `<div class="distance">üìç Distancia: ${dist.toFixed(2)} km</div>`;
  }

  const mapEmbedUrl = `https://maps.google.com/maps?q=${lat},${lon}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
  const mapNavUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;

  document.getElementById('result').innerHTML = `
    <div class="card">
      <h2>${d['SITEID']}</h2>
      <p style="margin-top:-10px; color:#64748b;">${d['NOMBRE DE SITIO']}</p>
      <div class="map-preview">
        <iframe src="${mapEmbedUrl}"></iframe>
      </div>
      ${distBox}
      <table class="data-table">
        <tr><td class="label">NIC/NIS:</td><td>${d['NIC/NIS']}</td></tr>
        <tr><td class="label">Distribuidora:</td><td>${d['Distribuidora']}</td></tr>
        <tr><td class="label">Llave Requerida:</td><td>${d['Llave Requerida']}</td></tr>
        <tr><td class="label">Municipio:</td><td>${d['Municipio']}</td></tr>
        <tr><td class="label">Direcci√≥n:</td><td>${d['Direccion']}</td></tr>
      </table>
      <a class="go-button" target="_blank" href="${mapNavUrl}">üöÄ ABRIR GPS</a>
    </div>
  `;
}
</script>
</body>
</html>
