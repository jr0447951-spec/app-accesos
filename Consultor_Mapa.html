<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consultor Mapa</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to bottom, #f7f9fc, #eef2f7);
    margin:0; padding:0;
    display:flex; flex-direction:column; align-items:center;
  }
  h1 {
    text-align:center;
    color:#1e3a8a;
    margin:20px 0 10px;
  }
  .search-container {
    width:90%;
    max-width:500px;
    margin-bottom:20px;
    position:relative;
  }
  input[type="text"] {
    width:100%;
    padding:10px 14px;
    font-size:1rem;
    border-radius:14px;
    border:1px solid #cbd5e1;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  .suggestions {
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:white;
    border:1px solid #cbd5e1;
    border-top:none;
    max-height:150px;
    overflow-y:auto;
    z-index:10;
    border-radius:0 0 14px 14px;
  }
  .suggestion-item {
    padding:8px 12px;
    cursor:pointer;
  }
  .suggestion-item:hover {
    background:#e0f2fe;
  }

  .card {
    background:white;
    border-radius:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    width:90%;
    max-width:500px;
    margin-bottom:30px;
    padding:15px;
  }
  .card h2 {
    font-size:1.1rem;
    margin-bottom:8px;
    color:#1e3a8a;
  }
  .map-preview iframe {
    width:100%;
    height:180px;
    border-radius:12px;
    border:none;
  }
  .distance{
    margin:10px 0;
    padding:10px 14px;
    background:#f0f4ff;
    color:#1e40af;
    border-radius:14px;
    font-weight:600;
    text-align:center;
    font-size:.95rem;
  }
  .data-table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
  }
  .data-table td {
    padding:6px 8px;
    border-bottom:1px solid #e2e8f0;
  }
  .data-table td.label {
    font-weight:600;
    color:#475569;
    width:40%;
  }
  .go-button {
    display:block;
    margin:15px auto 0;
    width:90%;
    max-width:400px;
    padding:12px;
    text-align:center;
    background:linear-gradient(90deg,#3b82f6,#60a5fa);
    color:white;
    border:none;
    border-radius:14px;
    font-weight:600;
    font-size:1rem;
    cursor:pointer;
    text-decoration:none;
  }
</style>
</head>
<body>
<h1>Consulta de Sitios</h1>

<div class="search-container">
  <input type="text" id="siteSearch" placeholder="Buscar por nombre del sitio">
  <div id="suggestions" class="suggestions"></div>
</div>

<div id="result"></div>

<script>
let sites = []; // Aqu铆 se cargar谩 el CSV
let userPosition = null;

// Cargar CSV desde GitHub (aseg煤rate de poner la URL raw correcta)
fetch('https://raw.githubusercontent.com/tu_usuario/tu_repo/main/Mapa_Base.csv')
.then(res => res.text())
.then(data => {
  const lines = data.split('\n').filter(l => l.trim() !== '');
  const headers = lines[0].split(';');
  sites = lines.slice(1).map(line => {
    const values = line.split(';');
    let obj = {};
    headers.forEach((h,i) => obj[h.trim()] = values[i]?.trim() || '');
    return obj;
  });
});

// Obtener ubicaci贸n del usuario
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(
    pos => { userPosition = {lat:pos.coords.latitude, lon:pos.coords.longitude}; },
    err => { console.warn("GPS no permitido"); }
  );
}

// Buscar sugerencias
const input = document.getElementById('siteSearch');
const suggestions = document.getElementById('suggestions');
input.addEventListener('input', ()=>{
  const query = input.value.toLowerCase();
  suggestions.innerHTML = '';
  if(query.length>0){
    sites.filter(s=>s['NOMBRE DE SITIO'].toLowerCase().includes(query))
         .slice(0,10)
         .forEach(s=>{
      const div = document.createElement('div');
      div.className='suggestion-item';
      div.textContent = s['NOMBRE DE SITIO'];
      div.onclick = ()=>selectSite(s);
      suggestions.appendChild(div);
    });
  }
});

// Funci贸n Haversine para distancia
function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// Mostrar datos del sitio
function selectSite(d){
  suggestions.innerHTML='';
  input.value = d['NOMBRE DE SITIO'];
  let distanceHTML = `<div class="distance"> Distancia: ubicaci贸n no disponible</div>`;
  if(userPosition){
    const km = getDistance(userPosition.lat, userPosition.lon, parseFloat(d.LATITUDE), parseFloat(d.LONGITUDE));
    distanceHTML = `<div class="distance"> Distancia desde tu ubicaci贸n: ${km.toFixed(1)} km</div>`;
  }

  document.getElementById('result').innerHTML = `
    <div class="card">
      <h2>${d['SITEID']} - ${d['NOMBRE DE SITIO']}</h2>
      <div class="map-preview">
        <iframe src="https://www.google.com/maps?q=${d.LATITUDE},${d.LONGITUDE}&hl=es;z=15&output=embed"></iframe>
      </div>
      ${distanceHTML}
      <table class="data-table">
        <tr><td class="label">NIC/NIS</td><td>${d['NIC/NIS']}</td></tr>
        <tr><td class="label">Distribuidora</td><td>${d['Distribuidora']}</td></tr>
        <tr><td class="label">Llave requerida</td><td>${d['Llave Requerida']}</td></tr>
        <tr><td class="label">Altura</td><td>${d['Altura']}</td></tr>
        <tr><td class="label">In-Building</td><td>${d['In-Building']}</td></tr>
        <tr><td class="label">Support Type</td><td>${d['Support Type']}</td></tr>
        <tr><td class="label">Porte</td><td>${d['Porte']}</td></tr>
        <tr><td class="label">Tech</td><td>${d['Tech']}</td></tr>
        <tr><td class="label">Tipo de Transmision</td><td>${d['Tipo de Transmision']}</td></tr>
        <tr><td class="label">Propietario</td><td>${d['Propietario']}</td></tr>
        <tr><td class="label">Tipo Ubicacion</td><td>${d['Tipo Ubicacion']}</td></tr>
        <tr><td class="label">Direccion</td><td>${d['Direccion']}</td></tr>
        <tr><td class="label">Municipio</td><td>${d['Municipio']}</td></tr>
      </table>
      <a class="go-button" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${d.LATITUDE},${d.LONGITUDE}"> Ir a Google Maps</a>
    </div>
  `;
}
</script>
</body>
</html>
