<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consultor Mapa</title>
<style>
  /* ... (Tus estilos se mantienen iguales) ... */
  .loading { color: #64748b; font-size: 0.8rem; margin-bottom: 10px; }
  .suggestion-item { border-bottom: 1px solid #f1f5f9; }
  .suggestion-item:last-child { border-bottom: none; }
</style>
</head>
<body>

<h1>Consulta de Sitios</h1>
<div id="status" class="loading">Cargando base de datos...</div>

<div class="search-container">
  <input type="text" id="siteSearch" placeholder="Escribe el nombre del sitio..." disabled>
  <div id="suggestions" class="suggestions"></div>
</div>

<div id="result"></div>

<script>
let sites = [];
let userPosition = null;

const input = document.getElementById('siteSearch');
const suggestions = document.getElementById('suggestions');
const statusDiv = document.getElementById('status');

// 1. CARGA DE DATOS MEJORADA
// Reemplaza con tu URL real. Ejemplo: 'https://raw.githubusercontent.com/usuario/repo/main/Mapa_Base.csv'
fetch('https://raw.githubusercontent.com/tu_usuario/tu_repo/main/Mapa_Base.csv')
  .then(res => res.text())
  .then(data => {
    const lines = data.split(/\r?\n/).filter(l => l.trim() !== '');
    const headers = lines[0].split(';').map(h => h.trim());
    
    sites = lines.slice(1).map(line => {
      const values = line.split(';');
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = values[i] ? values[i].trim() : '';
      });
      return obj;
    });

    statusDiv.textContent = "‚úÖ Base de datos lista";
    input.disabled = false; // Habilitar b√∫squeda solo cuando hay datos
    console.log("Datos cargados:", sites.length, "sitios");
  })
  .catch(err => {
    statusDiv.textContent = "‚ùå Error al cargar datos";
    console.error(err);
  });

// 2. GEOLOCALIZACI√ìN
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(
    pos => { userPosition = {lat: pos.coords.latitude, lon: pos.coords.longitude}; },
    err => { console.warn("GPS no disponible"); }
  );
}

// 3. BUSCADOR CORREGIDO
input.addEventListener('input', () => {
  const query = input.value.toLowerCase().trim();
  suggestions.innerHTML = '';

  if (query.length > 1) {
    const filtered = sites.filter(s => 
      s['NOMBRE DE SITIO'] && s['NOMBRE DE SITIO'].toLowerCase().includes(query)
    ).slice(0, 10);

    filtered.forEach(s => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.innerHTML = `<strong>${s['SITEID']}</strong> - ${s['NOMBRE DE SITIO']}`;
      div.onclick = () => selectSite(s);
      suggestions.appendChild(div);
    });
  }
});

// 4. FUNCI√ìN HAVERSINE (DISTANCIA)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + 
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// 5. MOSTRAR RESULTADOS
function selectSite(d) {
  suggestions.innerHTML = '';
  input.value = d['NOMBRE DE SITIO'];
  
  let distanceHTML = `<div class="distance">üìè Ubicaci√≥n GPS no disponible</div>`;
  
  // Limpiar coordenadas (algunos CSV usan coma en vez de punto)
  const lat = parseFloat(String(d.LATITUDE).replace(',', '.'));
  const lon = parseFloat(String(d.LONGITUDE).replace(',', '.'));

  if (userPosition && !isNaN(lat) && !isNaN(lon)) {
    const km = getDistance(userPosition.lat, userPosition.lon, lat, lon);
    distanceHTML = `<div class="distance">üìè A ${km.toFixed(1)} km de tu posici√≥n</div>`;
  }

  // URL corregida para Google Maps
  const mapEmbedUrl = `https://www.google.com/maps?q=${lat},${lon}&output=embed`;
  const mapNavUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;

  document.getElementById('result').innerHTML = `
    <div class="card">
      <h2>${d['SITEID']} - ${d['NOMBRE DE SITIO']}</h2>
      <div class="map-preview">
        <iframe src="${mapEmbedUrl}"></iframe>
      </div>
      ${distanceHTML}
      <table class="data-table">
        <tr><td class="label">NIC/NIS</td><td>${d['NIC/NIS'] || 'N/A'}</td></tr>
        <tr><td class="label">Distribuidora</td><td>${d['Distribuidora'] || 'N/A'}</td></tr>
        <tr><td class="label">Llave</td><td>${d['Llave Requerida'] || 'No'}</td></tr>
        <tr><td class="label">Tecnolog√≠a</td><td>${d['Tech'] || 'N/A'}</td></tr>
        <tr><td class="label">Transmisi√≥n</td><td>${d['Tipo de Transmision'] || 'N/A'}</td></tr>
        <tr><td class="label">Direcci√≥n</td><td>${d['Direccion'] || 'N/A'}</td></tr>
        <tr><td class="label">Municipio</td><td>${d['Municipio'] || 'N/A'}</td></tr>
      </table>
      <a class="go-button" target="_blank" href="${mapNavUrl}">üìç C√≥mo llegar (Google Maps)</a>
    </div>
  `;
}
</script>
</body>
</html>
