<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultor de Acceso</title>
    <style>
        :root { --primary: #1e3a8a; --accent: #3b82f6; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin:0; display:flex; flex-direction:column; align-items:center; color: #334155; padding-bottom: 40px; }
        
        header { width: 100%; background: white; padding: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.3rem; }
        .status { font-size: 0.75rem; margin-top: 5px; color: #64748b; }
        
        .search-container { width: 92%; max-width: 500px; position: relative; margin-bottom: 10px; }
        input[type="text"] { 
            width: 100%; padding: 14px 45px 14px 16px; font-size: 1rem; border-radius: 12px; 
            border: 2px solid #cbd5e1; box-sizing: border-box; outline: none;
        }

        .clear-btn { 
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: #cbd5e1; color: white; width: 26px; height: 26px; border-radius: 50%;
            display: none; align-items: center; justify-content: center; cursor: pointer;
        }

        .suggestions { 
            position: absolute; top: 105%; left: 0; right: 0; background: white; 
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            max-height: 250px; overflow-y: auto; z-index: 1000;
        }
        .suggestion-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggestion-item strong { color: var(--accent); display: block; }

        .card { 
            background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 92%; max-width: 500px; padding: 20px; box-sizing: border-box; animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        .header-title { 
            cursor: pointer; background: #eff6ff; padding: 15px; border-radius: 12px;
            border: 1px dashed var(--accent); margin-bottom: 15px; text-align: center;
        }
        .header-title h2 { margin:0; color: #1e3a8a; font-size: 1.1rem; }
        .copy-tag { font-size: 0.65rem; color: var(--accent); font-weight: bold; display: block; margin-top: 5px; }

        .map-preview { width: 100%; height: 180px; border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .map-preview iframe { width: 100%; height: 100%; border: none; }
        
        .dist-info { background: #f0fdf4; color: #166534; padding: 8px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 0.8rem; border: 1px solid #bbf7d0; }

        .info-box { margin-bottom: 12px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .info-box:last-child { border-bottom: none; }
        .label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 3px; }
        .val { font-size: 1rem; color: #1e293b; display: block; line-height: 1.4; }
        .highlight { color: #2563eb; font-weight: 700; }

        .go-button { 
            display: block; background: #2563eb; color: white; text-align: center;
            padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold;
            margin-top: 10px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        .toast {
            position: fixed; bottom: 30px; background: #1e293b; color: white;
            padding: 10px 25px; border-radius: 50px; font-size: 0.85rem;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000;
        }
    </style>
</head>
<body>

<header>
    <h1>Consultor de Acceso</h1>
    <div id="status" class="status">Cargando base de datos...</div>
</header>

<div class="search-container">
    <input type="text" id="siteSearch" placeholder="ID o Nombre del sitio..." disabled>
    <div id="clearSearch" class="clear-btn">‚úï</div>
    <div id="suggestions" class="suggestions"></div>
</div>

<div id="result"></div>
<div id="toast" class="toast">üìã Formato copiado para reporte</div>

<script>
let sites = [];
let userPos = null;

const input = document.getElementById('siteSearch');
const suggestions = document.getElementById('suggestions');
const statusDiv = document.getElementById('status');
const clearBtn = document.getElementById('clearSearch');
const toast = document.getElementById('toast');

const CSV_URL = 'https://raw.githubusercontent.com/jr0447951-spec/app-accesos/main/Mapa_Base.csv';

fetch(CSV_URL)
    .then(res => res.text())
    .then(data => {
        const rows = data.split(/\r?\n/).filter(row => row.trim() !== '');
        const headers = rows[0].split(';');
        
        sites = rows.slice(1).map(row => {
            const values = row.split(';');
            let obj = {};
            headers.forEach((h, i) => {
                let key = h.trim();
                // Normalizaci√≥n de columnas con caracteres especiales o espacios
                if(key.includes('Direcci')) key = 'DIRECCION';
                if(key.includes('Nombre para Propietario')) key = 'NOM_PROPIETARIO';
                if(key === 'Propietario') key = 'TIPO_PROPIETARIO';
                
                obj[key] = values[i] ? values[i].trim() : '';
            });
            return obj;
        });
        statusDiv.innerHTML = `‚úÖ <b>${sites.length}</b> sitios listos.`;
        input.disabled = false;
    })
    .catch(() => statusDiv.innerHTML = "‚ùå Error al conectar con GitHub.");

if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
        userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    });
}

input.addEventListener('input', () => {
    const query = input.value.toLowerCase().trim();
    suggestions.innerHTML = '';
    clearBtn.style.display = query.length > 0 ? 'flex' : 'none';
    if (query.length > 1) {
        const filtered = sites.filter(s => 
            (s['SITEID'] && s['SITEID'].toLowerCase().includes(query)) ||
            (s['NOMBRE DE SITIO'] && s['NOMBRE DE SITIO'].toLowerCase().includes(query))
        ).slice(0, 8);
        filtered.forEach(s => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `<strong>${s['SITEID']}</strong><span>${s['NOMBRE DE SITIO']}</span>`;
            div.onclick = () => selectSite(s);
            suggestions.appendChild(div);
        });
    }
});

function copyFormat(id, nombre) {
    const text = `*${id} - ${nombre}*`;
    navigator.clipboard.writeText(text).then(() => {
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    });
}

function selectSite(s) {
    suggestions.innerHTML = '';
    input.value = s['NOMBRE DE SITIO'];
    const lat = parseFloat(s.LATITUDE);
    const lon = parseFloat(s.LONGITUDE);

    let distHtml = '';
    if (userPos && !isNaN(lat)) {
        const R = 6371;
        const dLat = (lat - userPos.lat) * Math.PI / 180;
        const dLon = (lon - userPos.lon) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(userPos.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)**2;
        const km = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        distHtml = `<div class="dist-info">üìç A ${km.toFixed(2)} km de distancia</div>`;
    }

    const llaveVal = s['Llave Requerida'] ? s['Llave Requerida'].toUpperCase() : '';
    const llaveBox = (llaveVal === 'SI') ? `<div class="info-box"><span class="label">Acceso:</span><span class="val">üîë LLAVE REQUERIDA</span></div>` : '';

    document.getElementById('result').innerHTML = `
        <div class="card">
            <div class="header-title" onclick="copyFormat('${s['SITEID']}', '${s['NOMBRE DE SITIO']}')">
                <h2>${s['SITEID']} - ${s['NOMBRE DE SITIO']}</h2>
                <span class="copy-tag">üìã TOCAR PARA COPIAR</span>
            </div>
            
            <div class="map-preview">
                <iframe src="https://maps.google.com/maps?q=${lat},${lon}&z=16&output=embed"></iframe>
            </div>

            ${distHtml}

            <div class="info-box">
                <span class="label">NIC/NIS:</span>
                <span class="val highlight">${s['NIC/NIS'] || 'N/A'}</span>
            </div>

            <div class="info-box">
                <span class="label">Direcci√≥n:</span>
                <span class="val">${s['DIRECCION'] || 'No disponible'}</span>
            </div>

            <div class="info-box">
                <span class="label">Municipio:</span>
                <span class="val">${s['Municipio']}</span>
            </div>

            ${llaveBox}

            <div class="info-box">
                <span class="label">Nombre para Propietario:</span>
                <span class="val"><b>${s['NOM_PROPIETARIO'] || 'N/A'}</b></span>
            </div>

            <div class="info-box">
                <span class="label">Propietario:</span>
                <span class="val">${s['TIPO_PROPIETARIO'] || 'N/A'}</span>
            </div>

            <div class="info-box">
                <span class="label">Distribuidora:</span>
                <span class="val">${s['Distribuidora']}</span>
            </div>

            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="go-button">üöÄ INICIAR RUTA GPS</a>
        </div>
    `;
}

clearBtn.onclick = () => {
    input.value = '';
    suggestions.innerHTML = '';
    document.getElementById('result').innerHTML = '';
    clearBtn.style.display = 'none';
};
</script>
</body>
</html>
