<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Accesos Móvil - CSV</title>
<style>
body { font-family: Arial, sans-serif; margin: 15px; }
label { display: block; margin-top: 10px; }
input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
button { font-size: 16px; margin-top: 15px; }

.chips-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
.chip {
  padding: 8px 12px;
  border-radius: 20px;
  background-color: #f0f0f0;
  cursor: pointer;
  user-select: none;
  border: 1px solid #ccc;
}
.chip.selected { background-color: #4caf50; color: white; border-color: #4caf50; }

.autocomplete-items {
  position: relative;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  background: white;
}
.autocomplete-item {
  padding: 10px;
  cursor: pointer;
}
.autocomplete-item:hover {
  background-color: #e9e9e9;
}
</style>
</head>
<body>

<h2>Generador de Accesos (CSV) - Móvil Friendly</h2>

<label for="fileSitios">Cargar sitios.csv:</label>
<input type="file" id="fileSitios" accept=".csv">

<label for="fileTecnicos">Cargar tecnicos.csv:</label>
<input type="file" id="fileTecnicos" accept=".csv">

<label for="fileActividades">Cargar actividad.csv:</label>
<input type="file" id="fileActividades" accept=".csv">

<label for="fileVehiculos">Cargar vehiculos.csv:</label>
<input type="file" id="fileVehiculos" accept=".csv">

<label for="sitioInput">Sitio:</label>
<input type="text" id="sitioInput" placeholder="Escribe para autocompletar">
<div id="autocomplete-list" class="autocomplete-items"></div>

<label for="actividadSelect">Actividad:</label>
<select id="actividadSelect">
  <option value="">Seleccione actividad</option>
</select>

<label for="vehiculoSelect">Vehículo:</label>
<select id="vehiculoSelect">
  <option value="">Seleccione vehículo</option>
</select>

<label for="tecnicoPrincipalSelect">Técnico Principal:</label>
<select id="tecnicoPrincipalSelect"></select>

<label>Técnicos Adicionales:</label>
<div class="chips-container" id="tecnicosChipsDiv"></div>

<button id="generarWhatsAppBtn">Abrir WhatsApp</button>
<button id="copiarBtn">Generar y copiar al portapapeles</button>

<script>
let sitios = [];
let tecnicos = [];
let actividades = [];
let vehiculos = [];
let sitioSeleccionado = null;
let seleccionAdicional = new Set();

// --- Leer CSV ---
function parseCSV(text, delimiter=';') {
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(delimiter).map(h => h.trim());
  return lines.slice(1).map(line => {
    const data = line.split(delimiter).map(d => d.trim());
    const obj = {};
    headers.forEach((h,i)=>obj[h]=data[i]||'');
    return obj;
  });
}

// --- Cargar CSV ---
function cargarCSV(inputId, callback){
  const file = document.getElementById(inputId).files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => callback(evt.target.result);
  reader.readAsText(file);
}

// --- Sitios ---
document.getElementById('fileSitios').addEventListener('change', ()=>{
  cargarCSV('fileSitios', text=>{
    sitios = parseCSV(text);
    alert(`Cargados ${sitios.length} sitios`);
  });
});

// --- Técnicos ---
document.getElementById('fileTecnicos').addEventListener('change', ()=>{
  cargarCSV('fileTecnicos', text=>{
    tecnicos = parseCSV(text);
    populateTecnicoPrincipal();
    renderChips();
    alert(`Cargados ${tecnicos.length} técnicos`);
  });
});

// --- Actividades ---
document.getElementById('fileActividades').addEventListener('change', ()=>{
  cargarCSV('fileActividades', text=>{
    actividades = parseCSV(text);
    const select = document.getElementById('actividadSelect');
    select.innerHTML = '<option value="">Seleccione actividad</option>';
    actividades.forEach(a=>{
      const opt = document.createElement('option');
      opt.value = a.ACTIVIDAD;
      opt.textContent = a.ACTIVIDAD;
      select.appendChild(opt);
    });
  });
});

// --- Vehículos ---
document.getElementById('fileVehiculos').addEventListener('change', ()=>{
  cargarCSV('fileVehiculos', text=>{
    vehiculos = parseCSV(text);
    const select = document.getElementById('vehiculoSelect');
    select.innerHTML = '<option value="">Seleccione vehículo</option>';
    vehiculos.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = [v.Placa,v.Marca,v.Modelo,v.Color].join('|');
      opt.textContent = `${v.Placa} | ${v.Marca} | ${v.Modelo} | ${v.Color}`;
      select.appendChild(opt);
    });
  });
});

// --- Técnico principal ---
const tecnicoPrincipalSelect = document.getElementById('tecnicoPrincipalSelect');
function populateTecnicoPrincipal() {
  tecnicoPrincipalSelect.innerHTML = '';
  tecnicos.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.TECNICO;
    opt.textContent = `${t.TECNICO} (${t.DUI})`;
    tecnicoPrincipalSelect.appendChild(opt);
  });
}

// --- Técnicos adicionales ---
const tecnicosChipsDiv = document.getElementById('tecnicosChipsDiv');
function renderChips() {
  tecnicosChipsDiv.innerHTML = '';
  tecnicos.forEach(t=>{
    if(t.TECNICO === tecnicoPrincipalSelect.value) return;
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = `${t.TECNICO} (${t.DUI})`;
    chip.addEventListener('click', ()=>{
      if(seleccionAdicional.has(t.TECNICO)){
        seleccionAdicional.delete(t.TECNICO);
        chip.classList.remove('selected');
      } else {
        seleccionAdicional.add(t.TECNICO);
        chip.classList.add('selected');
      }
    });
    tecnicosChipsDiv.appendChild(chip);
  });
}
tecnicoPrincipalSelect.addEventListener('change', ()=>{
  seleccionAdicional.clear();
  renderChips();
});

// --- Autocompletado tipo dropdown ---
const sitioInput = document.getElementById('sitioInput');
const autocompleteList = document.getElementById('autocomplete-list');

sitioInput.addEventListener('input', ()=>{
  const val = sitioInput.value.toUpperCase();
  autocompleteList.innerHTML = '';
  if(!val) return;
  const matches = sitios.filter(s=>s['Nombre de Sitio'].toUpperCase().includes(val));
  matches.forEach(s=>{
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    item.textContent = `${s['Nombre de Sitio']} | ID: ${s.SiteID}`;
    item.addEventListener('click', ()=>{
      sitioInput.value = s['Nombre de Sitio'];
      sitioSeleccionado = s;
      autocompleteList.innerHTML = '';
    });
    autocompleteList.appendChild(item);
  });
});

// --- Generar mensaje ---
function generarMensaje() {
  if(!sitioSeleccionado){ alert('Seleccione un sitio válido'); return null; }
  const actividadSel = document.getElementById('actividadSelect').value;
  if(!actividadSel){ alert('Seleccione actividad'); return null; }
  const vehiculoSel = document.getElementById('vehiculoSelect').value;
  if(!vehiculoSel){ alert('Seleccione vehículo'); return null; }
  const [placa, marca, modelo, color] = vehiculoSel.split('|');

  const tecnicoPrincipal = tecnicos.find(t=>t.TECNICO === tecnicoPrincipalSelect.value);
  const tecnicosAdicionales = Array.from(seleccionAdicional).map(n=>tecnicos.find(t=>t.TECNICO===n));

  let listaTecnicos = [];
  listaTecnicos.push(`${tecnicoPrincipal.TECNICO}\t${tecnicoPrincipal.DUI} (${tecnicoPrincipal['FECHA DE NACIMIENTO']})`);
  tecnicosAdicionales.forEach(t=>{
    listaTecnicos.push(`${t.TECNICO}\t${t.DUI} (${t['FECHA DE NACIMIENTO']})`);
  });

  return `BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
▬▬▬▬▬▬▬▬▬▬
ID:${sitioSeleccionado.SiteID}
NOMBRE: ${sitioSeleccionado['Nombre de Sitio']}
PROPIETARIO: ${sitioSeleccionado.Torrero}
Nombre Torrero ${sitioSeleccionado['Nombre Torrero']}
▬▬▬▬▬▬▬▬▬▬
ACTIVIDAD: ${actividadSel}
▬▬▬▬▬▬▬▬▬▬
TECNICO PRINCIPAL/DUI
${listaTecnicos.join('\n')}
▬▬▬▬▬▬▬▬▬▬
Placa: ${placa}
Marca: ${marca}
Modelo: ${modelo}
Color: ${color}
▬▬▬▬▬▬▬▬▬▬
TELEFONO: ${tecnicoPrincipal.TELEFONO}
CORREO: ${tecnicoPrincipal.CORREO} tecnicossv@celectcac.com
`;
}

// --- Botón WhatsApp ---
document.getElementById('generarWhatsAppBtn').addEventListener('click', ()=>{
  const mensaje = generarMensaje();
  if(!mensaje) return;
  const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
  window.open(urlWhatsApp, '_blank');
});

// --- Botón Copiar ---
document.getElementById('copiarBtn').addEventListener('click', ()=>{
  const mensaje = generarMensaje();
  if(!mensaje) return;
  navigator.clipboard.writeText(mensaje).then(()=>{
    alert('Mensaje copiado al portapapeles');
  }).catch(()=> alert('Error al copiar al portapapeles'));
});
</script>

</body>
</html>






