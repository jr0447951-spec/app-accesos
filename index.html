<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Accesos Movistar</title>

<style>
body{
  font-family: Arial, sans-serif;
  padding: 15px;
  background: linear-gradient(135deg,#f0f4ff,#e0f7f1);
}
h2{text-align:center;}
label{font-weight:bold;margin-top:12px;display:block;}
input,select,textarea{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box;
}
#listaSitios{
  position:absolute;
  background:#fff;
  width:100%;
  border:1px solid #ccc;
  max-height:150px;
  overflow:auto;
  z-index:1000;
}
#listaSitios div{
  padding:8px;
  cursor:pointer;
}
#listaSitios div:hover{background:#f1f1f1;}
.chip{
  display:inline-block;
  padding:6px 12px;
  margin:4px;
  background:#e0e0e0;
  border-radius:20px;
  cursor:pointer;
}
.chip.selected{
  background:#4CAF50;
  color:white;
}
button{
  margin-top:15px;
  padding:12px;
  width:100%;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
#generar{background:#2196F3;color:white;}
#whatsapp{background:#4CAF50;color:white;}
textarea{
  height:220px;
  margin-top:10px;
  font-family:monospace;
}
.error{
  color:#d32f2f;
  font-weight:bold;
  display:none;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>Generador de Accesos Movistar / CELECT</h2>

<label>Sitio</label>
<div style="position:relative">
  <input id="sitio" placeholder="Buscar sitio">
  <div id="listaSitios"></div>
</div>

<label>Actividad</label>
<select id="actividad">
  <option value="">Seleccione actividad</option>
</select>

<label>Vehículo</label>
<select id="vehiculo">
  <option value="">Seleccione vehículo</option>
</select>

<label>Técnico Principal</label>
<select id="tecnicoPrincipal">
  <option value="">Seleccione técnico</option>
</select>

<label>Técnicos Adicionales</label>
<div id="tecnicosAdicionales"></div>

<label>Vista previa</label>
<textarea id="preview" readonly></textarea>

<div class="error" id="errorBox">
Completa los datos para generar mensaje.
</div>

<button id="generar">Generar y Copiar</button>
<button id="whatsapp">Enviar por WhatsApp</button>

<script>
// ================= VARIABLES =================
let sitios=[], actividades=[], tecnicos=[], vehiculos=[];

// ================= CSV =================
async function cargarCSV(url){
  const res = await fetch(url);
  const text = await res.text();
  const [head,...rows] = text.trim().split('\n');
  const headers = head.split(';');
  return rows.map(r=>{
    const cols = r.split(';');
    let o={};
    headers.forEach((h,i)=>o[h.trim()]=cols[i]?.trim());
    return o;
  });
}

// ================= INIT =================
async function init(){
  [sitios,actividades,tecnicos,vehiculos] = await Promise.all([
    cargarCSV('sitios.csv'),
    cargarCSV('actividad.csv'),
    cargarCSV('tecnicos.csv'),
    cargarCSV('vehiculos.csv')
  ]);
  cargarUI();
}
init();

// ================= UI =================
function cargarUI(){
  actividades.forEach(a=>{
    const o=document.createElement('option');
    o.value=a.ACTIVIDAD;
    o.textContent=a.ACTIVIDAD;
    actividad.appendChild(o);
  });

  vehiculos.forEach(v=>{
    const o=document.createElement('option');
    o.textContent=`${v.Placa} - ${v.Marca} ${v.Modelo}`;
    vehiculo.appendChild(o);
  });

  tecnicos.forEach((t,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=`${t.TECNICO} (${t.DUI})`;
    tecnicoPrincipal.appendChild(o);

    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent=`${t.TECNICO} (${t.DUI})`;
    chip.dataset.index=i;
    chip.onclick=()=>chip.classList.toggle('selected');
    tecnicosAdicionales.appendChild(chip);
  });
}

// ================= SITIOS =================
sitio.addEventListener('input',()=>{
  listaSitios.innerHTML='';
  const v=sitio.value.toLowerCase();
  if(!v) return;
  sitios.filter(s=>s['Nombre de Sitio'].toLowerCase().includes(v))
    .slice(0,10)
    .forEach(s=>{
      const d=document.createElement('div');
      d.textContent=`${s['Nombre de Sitio']} (${s.SiteID})`;
      d.onclick=()=>{
        sitio.value=s['Nombre de Sitio'];
        sitio.dataset.siteid=s.SiteID;
        sitio.dataset.torrero=s.Torrero;
        sitio.dataset.nombretorrero=s['Nombre Torrero'];
        listaSitios.innerHTML='';
        actualizarPreview();
      };
      listaSitios.appendChild(d);
    });
});

// ================= VALIDACIÓN =================
function validar(){
  return sitio.dataset.siteid && actividad.value && tecnicoPrincipal.value;
}

// ================= MENSAJE =================
function generarMensaje(){
  const tp=tecnicos[tecnicoPrincipal.value];
  const adicionales=[...document.querySelectorAll('.chip.selected')]
    .map(c=>tecnicos[c.dataset.index]);
  const veh=vehiculos[vehiculo.selectedIndex-1]||{};

  const bloqueTecnicos=[tp,...adicionales]
    .map(t=>`${t.TECNICO}\t${t.DUI} (${t['FECHA DE NACIMIENTO']||''})`)
    .join('\n');

  return `BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
▬▬▬▬▬▬▬▬▬▬
ID:${sitio.dataset.siteid}
NOMBRE: ${sitio.value}
PROPIETARIO: ${sitio.dataset.torrero}
Nombre Torrero ${sitio.dataset.nombretorrero}
▬▬▬▬▬▬▬▬▬▬
ACTIVIDAD: ${actividad.value}
▬▬▬▬▬▬▬▬▬▬
TECNICOS/DUI
${bloqueTecnicos}
▬▬▬▬▬▬▬▬▬▬
Placa: ${veh.Placa||''}
Marca: ${veh.Marca||''}
Modelo: ${veh.Modelo||''}
Color: ${veh.Color||''}
▬▬▬▬▬▬▬▬▬▬
Empresa: CELECT SA DE CV
Supervisor: José Rivas
Teléfono supervisor:6161 4465
▬▬▬▬▬▬▬▬▬▬
TELEFONO: ${tp.TELEFONO||''}
CORREO: ${tp.CORREO||''} tecnicossv@celectcac.com`;
}

// ================= PREVIEW =================
function actualizarPreview(){
  if(!validar()){
    preview.value='';
    errorBox.style.display='block';
    return;
  }
  errorBox.style.display='none';
  preview.value=generarMensaje();
}

['actividad','vehiculo','tecnicoPrincipal']
.forEach(id=>document.getElementById(id).addEventListener('change',actualizarPreview));

// ================= BOTONES =================
generar.onclick=()=>{
  if(!validar()) return;
  navigator.clipboard.writeText(generarMensaje());
  alert('Copiado al portapapeles');
};

whatsapp.onclick=()=>{
  if(!validar()) return;
  window.open(`https://wa.me/?text=${encodeURIComponent(generarMensaje())}`);
};
</script>

</body>
</html>

