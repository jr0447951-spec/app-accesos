<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Acceso</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1 { text-align: center; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  select, input, button { width: 100%; padding: 10px; margin-top: 5px; font-size: 16px; }
  .chip { display: inline-block; padding: 10px; margin: 3px; border-radius: 20px; background: #eee; cursor: pointer; }
  .chip.selected { background: #4CAF50; color: white; }
  button { cursor: pointer; }
</style>
</head>
<body>
<h1>Generador de Acceso</h1>

<label for="sitio">Sitio:</label>
<input type="text" id="sitio" placeholder="Escriba el sitio...">

<label for="actividad">Actividad:</label>
<select id="actividad"></select>

<label for="vehiculo">Vehículo:</label>
<select id="vehiculo"></select>

<label>Técnico Principal:</label>
<select id="tecnicoPrincipal"></select>

<label>Técnicos Adicionales:</label>
<div id="tecnicosAdicionales"></div>

<button id="generar">Generar y Copiar</button>
<button id="whatsapp">Enviar por WhatsApp</button>

<script>
// Función para leer CSV
async function leerCSV(ruta, separador=';') {
  const resp = await fetch(ruta);
  const text = await resp.text();
  const lineas = text.trim().split('\n');
  const encabezados = lineas[0].split(separador).map(h => h.trim());
  return lineas.slice(1).map(l => {
    const valores = l.split(separador).map(v => v.trim());
    let obj = {};
    encabezados.forEach((h,i) => obj[h] = valores[i] || '');
    return obj;
  });
}

// Variables globales
let sitios = [], actividades = [], tecnicos = [], vehiculos = [];

// Cargar datos
async function cargarDatos() {
  sitios = await leerCSV('sitios.csv');
  actividades = await leerCSV('actividad.csv', ';');
  tecnicos = await leerCSV('tecnicos.csv');
  vehiculos = await leerCSV('vehiculos.csv');

  // Sitios Autocomplete
  const inputSitio = document.getElementById('sitio');
  inputSitio.addEventListener('input', () => {
    const val = inputSitio.value.toLowerCase();
    const opciones = sitios.filter(s => s['Nombre de Sitio'].toLowerCase().includes(val));
    // Mostrar coincidencias debajo
    let lista = document.getElementById('listaSitios');
    if (!lista) {
      lista = document.createElement('div');
      lista.id = 'listaSitios';
      lista.style.border = '1px solid #ccc';
      lista.style.background = 'white';
      lista.style.position = 'absolute';
      lista.style.width = inputSitio.offsetWidth + 'px';
      inputSitio.parentNode.appendChild(lista);
    }
    lista.innerHTML = '';
    opciones.forEach(s => {
      const div = document.createElement('div');
      div.textContent = `${s['Nombre de Sitio']} (${s.SiteID})`;
      div.style.padding = '5px';
      div.style.cursor = 'pointer';
      div.addEventListener('click', () => {
        inputSitio.value = s['Nombre de Sitio'];
        inputSitio.dataset.siteid = s.SiteID;
        inputSitio.dataset.torrero = s.Torrero;
        inputSitio.dataset.nombretorrero = s['Nombre Torrero'];
        lista.innerHTML = '';
      });
      lista.appendChild(div);
    });
  });

  // Actividades Dropdown
  const selectActividad = document.getElementById('actividad');
  actividades.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a['ACTIVIDAD'];
    opt.textContent = a['ACTIVIDAD'];
    selectActividad.appendChild(opt);
  });

  // Vehículos Dropdown
  const selectVehiculo = document.getElementById('vehiculo');
  vehiculos.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.Placa;
    opt.textContent = `${v.Placa} | ${v.Marca} | ${v.Modelo} | ${v.Color}`;
    opt.dataset.marca = v.Marca;
    opt.dataset.modelo = v.Modelo;
    opt.dataset.color = v.Color;
    selectVehiculo.appendChild(opt);
  });

  // Técnicos Principal
  const selectTecnico = document.getElementById('tecnicoPrincipal');
  tecnicos.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.TECNICO;
    opt.textContent = `${t.TECNICO} (${t.DUI})`;
    opt.dataset.dui = t.DUI;
    opt.dataset.telefono = t.TELEFONO;
    opt.dataset.correo = t.CORREO;
    opt.dataset.fecha = t['FECHA DE NACIMIENTO'];
    selectTecnico.appendChild(opt);
  });

  // Técnicos Adicionales Chips
  const divTecnicos = document.getElementById('tecnicosAdicionales');
  tecnicos.forEach((t,i) => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = t.TECNICO;
    chip.dataset.index = i;
    chip.addEventListener('click', () => {
      chip.classList.toggle('selected');
      actualizarSeleccionados();
    });
    divTecnicos.appendChild(chip);
  });
}

// Para que no se seleccione principal en adicionales
function actualizarSeleccionados() {
  const principal = document.getElementById('tecnicoPrincipal').value;
  document.querySelectorAll('#tecnicosAdicionales .chip').forEach(c => {
    const t = tecnicos[c.dataset.index].TECNICO;
    if (t === principal) {
      c.classList.remove('selected');
      c.style.display = 'none';
    } else {
      c.style.display = 'inline-block';
    }
  });
}

// Generar mensaje
function generarMensaje() {
  const sitioInput = document.getElementById('sitio');
  const sitio = {
    SiteID: sitioInput.dataset.siteid || '',
    Nombre: sitioInput.value || '',
    Torrero: sitioInput.dataset.torrero || '',
    NombreTorrero: sitioInput.dataset.nombretorrero || ''
  };
  const actividad = document.getElementById('actividad').value;
  const vehSelect = document.getElementById('vehiculo').selectedOptions[0];
  const vehiculo = {
    Placa: vehSelect.value,
    Marca: vehSelect.dataset.marca,
    Modelo: vehSelect.dataset.modelo,
    Color: vehSelect.dataset.color
  };
  const principalSel = document.getElementById('tecnicoPrincipal').selectedOptions[0];
  const tecnicoPrincipal = {
    TECNICO: principalSel.value,
    DUI: principalSel.dataset.dui,
    TELEFONO: principalSel.dataset.telefono,
    CORREO: principalSel.dataset.correo,
    FECHA: principalSel.dataset.fecha
  };
  // Adicionales
  const adicionales = [];
  const chips = document.querySelectorAll('#tecnicosAdicionales .chip.selected');
  chips.forEach(c => {
    const t = tecnicos[c.dataset.index];
    adicionales.push(`${t.TECNICO}\t${t.DUI} (${t['FECHA DE NACIMIENTO']})`);
  });

  const bloqueTecnicos = `${tecnicoPrincipal.TECNICO}\t${tecnicoPrincipal.DUI} (${tecnicoPrincipal.FECHA})\n${adicionales.join('\n')}`;

  const mensaje = `BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
▬▬▬▬▬▬▬▬▬▬
ID:${sitio.SiteID}
NOMBRE: ${sitio.Nombre}
PROPIETARIO: ${sitio.Torrero}
Nombre Torrero ${sitio.NombreTorrero}
▬▬▬▬▬▬▬▬▬▬
ACTIVIDAD: ${actividad}
▬▬▬▬▬▬▬▬▬▬
TECNICO PRINCIPAL/DUI
${bloqueTecnicos}
▬▬▬▬▬▬▬▬▬▬
Placa: ${vehiculo.Placa}
Marca: ${vehiculo.Marca}
Modelo: ${vehiculo.Modelo}
Color: ${vehiculo.Color}
▬▬▬▬▬▬▬▬▬▬
TELEFONO: ${tecnicoPrincipal.TELEFONO}
CORREO: ${tecnicoPrincipal.CORREO} tecnicossv@celectcac.com
`;
  return mensaje;
}

// Botones
document.getElementById('generar').addEventListener('click', () => {
  const msg = generarMensaje();
  navigator.clipboard.writeText(msg).then(() => alert('Mensaje copiado al portapapeles'));
});

document.getElementById('whatsapp').addEventListener('click', () => {
  const msg = generarMensaje();
  const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
});

// Inicializar
cargarDatos();
</script>
</body>
</html>


