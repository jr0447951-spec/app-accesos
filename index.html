<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Accesos a sitios MOVISTAR</title>
<style>
  body { font-family: Arial, sans-serif; padding: 15px; background: #f0f8ff; color:#333; }
  h2 { text-align:center; color:#2c3e50; }
  label { display:block; margin-top:10px; font-weight:bold; }
  input, select, textarea { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; }
  #listaSitios { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:150px; overflow-y:auto; z-index:1000; border-radius:0 0 6px 6px; }
  #listaSitios div { padding:5px; cursor:pointer; }
  #listaSitios div:hover { background:#f1f9fe; }
  .chip { display:inline-block; padding:6px 12px; margin:3px; background:#eee; border-radius:25px; cursor:pointer; user-select:none; transition:0.2s; }
  .chip:hover { transform:translateY(-1px); background:#ddd; }
  .chip.selected { background:#4CAF50; color:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
  .chip.disabled { opacity:0.5; cursor:not-allowed; }
  #contadorSeleccionados { margin-top:5px; font-size:14px; color:#555; }
  textarea { height:220px; font-family:monospace; margin-top:10px; }
  button { padding:10px; margin-top:10px; width:100%; font-size:16px; border:none; border-radius:8px; cursor:pointer; color:white; font-weight:bold; transition:0.2s; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
  button:hover { transform:translateY(-2px); opacity:0.9; }
  #generar { background:#2196F3; }
  #whatsapp { background:#4CAF50; }
  #pag2 { background:#FF9800; }
</style>
</head>
<body>

<h2>Generador de Accesos a sitios MOVISTAR</h2>

<label for="sitio">Sitio:</label>
<div style="position: relative;">
  <input type="text" id="sitio" placeholder="Escriba el sitio..." autocomplete="off">
  <div id="listaSitios"></div>
</div>

<label for="actividad">Actividad:</label>
<select id="actividad"><option value="">Seleccione una actividad</option></select>

<label for="vehiculo">Vehículo:</label>
<select id="vehiculo"><option value="">Seleccione un vehículo</option></select>

<label for="tecnicoPrincipal">Técnico Principal:</label>
<select id="tecnicoPrincipal"><option value="">Seleccione técnico principal</option></select>

<label>Técnicos Adicionales:</label>
<div id="tecnicosAdicionales"></div>
<div id="contadorSeleccionados">Seleccionados: 0</div>

<label>Vista Previa:</label>
<textarea id="vistaPrevia" readonly placeholder="Complete los campos para generar el mensaje..."></textarea>

<button id="generar">Generar y Copiar al Portapapeles</button>
<button id="whatsapp">Enviar por WhatsApp</button>
<button id="pag2">Ir a INGRESO/SALIDA</button>

<script>
let sitios=[], actividades=[], tecnicos=[], vehiculos=[];

// --- Cargar CSV ---
async function cargarCSV(url){
  const res = await fetch(url);
  const text = await res.text();
  const lineas = text.trim().split('\n');
  const headers = lineas[0].split(';');
  return lineas.slice(1).map(l=>{
    const cols = l.split(';'); let obj={};
    headers.forEach((h,i)=>obj[h.trim()]=cols[i]?.trim());
    return obj;
  });
}

// --- Inicialización ---
async function inicializar(){
  sitios = await cargarCSV('sitios.csv');
  actividades = await cargarCSV('actividad.csv');
  tecnicos = await cargarCSV('tecnicos.csv');
  vehiculos = await cargarCSV('vehiculos.csv');

  // Llenar actividades
  const selAct = document.getElementById('actividad');
  actividades.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a['ACTIVIDAD']; opt.textContent = a['ACTIVIDAD'];
    selAct.appendChild(opt);
  });

  // Llenar vehículos
  const selVeh = document.getElementById('vehiculo');
  vehiculos.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.Placa; opt.textContent = `${v.Placa} - ${v.Marca} ${v.Modelo} (${v.Color})`;
    selVeh.appendChild(opt);
  });

  // Técnico principal y chips
  const selTecPrin = document.getElementById('tecnicoPrincipal');
  const divTecAdd = document.getElementById('tecnicosAdicionales');

  tecnicos.forEach((t,i)=>{
    // Principal
    const opt = document.createElement('option'); opt.value=i; opt.textContent=`${t.TECNICO} (${t.DUI})`;
    selTecPrin.appendChild(opt);

    // Chip adicional
    const chip = document.createElement('div');
    chip.className='chip'; chip.textContent=`${t.TECNICO} (${t.DUI})`;
    chip.dataset.index=i;
    chip.addEventListener('click',()=>{
      if(parseInt(selTecPrin.value)===i) return; // no seleccionar principal
      chip.classList.toggle('selected'); actualizarPreview(); actualizarContador();
    });
    divTecAdd.appendChild(chip);
  });

  selTecPrin.addEventListener('change',()=>{
    document.querySelectorAll('#tecnicosAdicionales .chip').forEach(chip=>{
      const idx=parseInt(chip.dataset.index);
      if(idx===parseInt(selTecPrin.value)){
        chip.classList.remove('selected');
        chip.classList.add('disabled');
      }else{
        chip.classList.remove('disabled');
      }
    });
    actualizarPreview(); actualizarContador();
  });

  actualizarPreview(); actualizarContador();
}

function actualizarContador(){
  const count=document.querySelectorAll('#tecnicosAdicionales .chip.selected').length;
  document.getElementById('contadorSeleccionados').textContent=`Seleccionados: ${count}`;
}

// --- Autocompletado sitios ---
const inputSitio=document.getElementById('sitio');
const lista=document.getElementById('listaSitios');
inputSitio.addEventListener('input',()=>{
  const val=inputSitio.value.toLowerCase();
  lista.innerHTML='';
  if(!val) return;
  sitios.filter(s=>s['Nombre de Sitio'].toLowerCase().includes(val))
    .slice(0,10)
    .forEach(s=>{
      const div=document.createElement('div');
      div.textContent=`${s['Nombre de Sitio']} (${s.SiteID})`;
      div.addEventListener('click',()=>{
        inputSitio.value=s['Nombre de Sitio'];
        inputSitio.dataset.siteid=s.SiteID;
        inputSitio.dataset.torrero=s.Torrero;
        inputSitio.dataset.nombretorrero=s['Nombre Torrero'];
        lista.innerHTML=''; actualizarPreview();
      });
      lista.appendChild(div);
    });
});

document.addEventListener('click',e=>{
  if(!inputSitio.contains(e.target)&&!lista.contains(e.target)) lista.innerHTML='';
});

// --- Generar mensaje ---
function generarMensaje(){
  const sitio={
    SiteID: inputSitio.dataset.siteid||'',
    Nombre: inputSitio.value||'',
    Torrero: inputSitio.dataset.torrero||'',
    NombreTorrero: inputSitio.dataset.nombretorrero||''
  };
  const actividad=document.getElementById('actividad').value;
  const vehiculo=vehiculos[document.getElementById('vehiculo').selectedIndex-1]||{};
  const tecPrinIndex=parseInt(document.getElementById('tecnicoPrincipal').value);
  const tecnicoPrincipal=tecnicos[tecPrinIndex]||{};
  const adicionales=Array.from(document.querySelectorAll('.chip.selected')).map(c=>tecnicos[c.dataset.index]);
  const todos=[tecnicoPrincipal,...adicionales].filter(Boolean);
  if(!sitio.SiteID||!actividad||!tecnicoPrincipal.TECNICO) return "Complete los datos para generar mensaje.";

  const bloqueTecnicos=todos.map(t=>`${t.TECNICO}\t${t.DUI} (${t['FECHA DE NACIMIENTO']})`).join('\n');

  return `BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
▬▬▬▬▬▬▬▬▬▬
ID:${sitio.SiteID}
NOMBRE: ${sitio.Nombre}
PROPIETARIO: ${sitio.Torrero}
Nombre Torrero ${sitio.NombreTorrero}
▬▬▬▬▬▬▬▬▬▬
ACTIVIDAD: ${actividad}
▬▬▬▬▬▬▬▬▬▬
TECNICOS/DUI
${bloqueTecnicos}
▬▬▬▬▬▬▬▬▬▬
Placa: ${vehiculo.Placa||''}
Marca: ${vehiculo.Marca||''}
Modelo: ${vehiculo.Modelo||''}
Color: ${vehiculo.Color||''}
▬▬▬▬▬▬▬▬▬▬
Empresa: CELECT SA DE CV
Supervisor: José Rivas
Teléfono supervisor:6161 4465
▬▬▬▬▬▬▬▬▬▬
TELEFONO: ${tecnicoPrincipal.TELEFONO||''}
CORREO: ${tecnicoPrincipal.CORREO||''} tecnicossv@celectcac.com`;
}

function actualizarPreview(){ document.getElementById('vistaPrevia').value=generarMensaje(); }

// --- Listeners ---
document.getElementById('actividad').addEventListener('change', actualizarPreview);
document.getElementById('vehiculo').addEventListener('change', actualizarPreview);
document.getElementById('tecnicoPrincipal').addEventListener('change', actualizarPreview);

document.getElementById('generar').addEventListener('click',()=>{
  const msg=generarMensaje();
  if(msg.startsWith("Complete")) return alert(msg);
  navigator.clipboard.writeText(msg).then(()=>alert('Copiado al portapapeles'));
});

document.getElementById('whatsapp').addEventListener('click',()=>{
  const msg=generarMensaje();
  if(msg.startsWith("Complete")) return alert(msg);
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
});

// --- Botón para pag2.html ---
document.getElementById('pag2').addEventListener('click',()=>{
  window.location.href='pag2.html';
});

// --- Inicializar ---
inicializar();
</script>

</body>
</html>



