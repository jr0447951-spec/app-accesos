<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Accesos</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078D4">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f4f4f4;
    }
    h2 {
      text-align: center;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    textarea {
      height: 260px;
      margin-top: 15px;
    }
    button {
      background: #0078D4;
      color: white;
      border: none;
      margin-top: 15px;
      font-size: 16px;
    }
    .checkbox-container {
      display: flex;
      flex-direction: column;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h2>üìã Generador de Accesos</h2>

<!-- AUTOCOMPLETADO PARA SITIOS -->
<label>Seleccionar Sitio</label>
<input type="text" id="buscarSitio" placeholder="Escribe nombre del sitio" oninput="filtrarSitios()" autocomplete="off">
<div id="autocompleteContainer" class="autocomplete-items"></div>

<label>Actividad</label>
<select id="actividad"></select>

<label>T√©cnico Principal</label>
<select id="tecnicoPrincipal"></select>

<label>T√©cnicos Adicionales</label>
<!-- Cambi√© los checkboxes por un select m√∫ltiple -->
<select id="tecnicosAdicionales" multiple></select>

<label>Veh√≠culo</label>
<select id="vehiculo"></select>

<button onclick="generarMensaje()">Generar y Copiar</button>

<textarea id="resultado" placeholder="Aqu√≠ aparecer√° el mensaje..."></textarea>

<script>
/* ================= VARIABLES ================= */
let sitios = [];
let tecnicos = [];
let vehiculos = [];
let actividades = [];

/* ================= LEER CSV ================= */
async function leerCSV(archivo) {
  const res = await fetch(archivo);
  const texto = await res.text();
  const lineas = texto.split("\n").map(l => l.trim()).filter(l => l); // Divide por l√≠neas
  const encabezados = lineas[0].split(";"); // Usamos punto y coma como delimitador

  return lineas.slice(1).map(linea => {
    const valores = linea.split(";");
    let obj = {};
    encabezados.forEach((h, i) => obj[h] = valores[i]);
    return obj;
  });
}

/* ================= CARGAR DATOS ================= */
async function cargarDatos() {
  sitios = await leerCSV("sitios.csv");
  tecnicos = await leerCSV("tecnicos.csv");
  vehiculos = await leerCSV("vehiculos.csv");
  actividades = await leerCSV("actividad.csv");

  cargarCombos(); // Llamamos a cargarCombos despu√©s de cargar los datos
}

/* ================= LLENAR COMBOS ================= */
function cargarCombos() {
  const cmbActividad = document.getElementById("actividad");
  const cmbTecnico = document.getElementById("tecnicoPrincipal");
  const cmbVehiculo = document.getElementById("vehiculo");
  const cmbTecnicosAdicionales = document.getElementById("tecnicosAdicionales");

  // Cargar las actividades
  actividades.forEach(a => {
    cmbActividad.add(new Option(a.ACTIVIDAD, a.ACTIVIDAD)); // Usamos la propiedad ACTIVIDAD
  });

  // Verificar y cargar t√©cnicos (para T√©cnico Principal y T√©cnicos Adicionales)
  tecnicos.forEach((t, i) => {
    // T√©cnico Principal
    cmbTecnico.add(new Option(t.TECNICO, i));

    // T√©cnicos Adicionales: Crear opci√≥n para cada t√©cnico
    const option = document.createElement("option");
    option.value = i;
    option.text = t.TECNICO;
    cmbTecnicosAdicionales.appendChild(option);
  });

  // Verificar y cargar veh√≠culos
  vehiculos.forEach((v, i) => {
    cmbVehiculo.add(new Option(`${v.Placa} - ${v.Marca}`, i));
  });
}

/* ================= FILTRAR SITIOS POR NOMBRE ================= */
function filtrarSitios() {
  const input = document.getElementById("buscarSitio");
  const filtro = input.value.toLowerCase();
  const autocompleteContainer = document.getElementById("autocompleteContainer");

  // Limpiar contenido anterior de autocompletado
  autocompleteContainer.innerHTML = "";

  // Filtrar sitios por Nombre
  const filtrados = sitios.filter(s =>
    s['Nombre de Sitio'].toLowerCase().includes(filtro) // Filtra por Nombre de Sitio
  );

  // Mostrar resultados de autocompletado
  filtrados.forEach(s => {
    const item = document.createElement("div");
    item.innerHTML = `${s.SiteID} - ${s['Nombre de Sitio']}`;
    item.addEventListener("click", function() {
      // Rellenar el input con la selecci√≥n
      input.value = `${s.SiteID} - ${s['Nombre de Sitio']}`;
      // Eliminar lista de autocompletado
      autocompleteContainer.innerHTML = "";
      // Aqu√≠ puedes almacenar el SiteID de forma interna para generar el mensaje
      selectedSiteID = s.SiteID; // Guarda el ID seleccionado para usarlo m√°s tarde
    });
    autocompleteContainer.appendChild(item);
  });
}

/* ================= GENERAR MENSAJE ================= */
function generarMensaje() {
  const sitioSeleccionado = sitios.find(s => s.SiteID === selectedSiteID); // Busca el sitio con el ID seleccionado

  if (!sitioSeleccionado) {
    alert("Selecciona un sitio v√°lido");
    return;
  }

  const actividadSel = document.getElementById("actividad").value;
  const tecnicoPrincipalIdx = document.getElementById("tecnicoPrincipal").value;
  const tecnicoPrincipal = tecnicos[tecnicoPrincipalIdx];

  // Obtener los t√©cnicos adicionales seleccionados
  const tecnicosAdicionales = [];
  const duiAdicionales = []; // Para almacenar los DUI de los t√©cnicos adicionales
  const selectTecnicos = document.getElementById("tecnicosAdicionales");

  for (let i = 0; i < selectTecnicos.selectedOptions.length; i++) {
    const tecnicoAdicional = tecnicos[selectTecnicos.selectedOptions[i].value];
    tecnicosAdicionales.push(tecnicoAdicional.TECNICO);
    duiAdicionales.push(tecnicoAdicional.DUI); // Agregar DUI de t√©cnicos adicionales
  }

  const veh = vehiculos[document.getElementById("vehiculo").value];

  const mensaje =
`BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
ID:${sitioSeleccionado.SiteID}
NOMBRE: ${sitioSeleccionado['Nombre de Sitio']}
PROPIETARIO: ${sitioSeleccionado.Torrero}
Nombre Torrero ${sitioSeleccionado['Nombre Torrero']}
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
ACTIVIDAD: ${actividadSel}
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
TECNICO PRINCIPAL/DUI
${tecnicoPrincipal.TECNICO}\t${tecnicoPrincipal.DUI}
${tecnicosAdicionales.map((tecnico, idx) => `${tecnico} ${duiAdicionales[idx]}`).join("\n")}
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
Placa: ${veh.Placa}
Marca: ${veh.Marca}
Modelo: ${veh.Modelo}
Color: ${veh.Color}
‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨
TELEFONO: ${tecnicoPrincipal.TELEFONO}
CORREO: ${tecnicoPrincipal.CORREO} tecnicossv@celectcac.com
`;


  document.getElementById("resultado").value = mensaje;

  // Copiar al portapapeles
  navigator.clipboard.writeText(mensaje)
    .then(() => alert("Mensaje copiado al portapapeles"))
    .catch(() => alert("No se pudo copiar"));
}

let selectedSiteID = ""; // Variable para almacenar el SiteID seleccionado

window.onload = cargarDatos;
</script>

</body>
</html>

