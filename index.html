<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Acceso</title>
<style>
body { font-family: Arial; padding: 10px; max-width: 600px; margin: auto; }
h1 { text-align: center; }
input, select, button { width: 100%; padding: 10px; margin: 5px 0 15px 0; box-sizing: border-box; font-size: 16px; }
button { cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 5px; }
button:hover { background-color: #0056b3; }
textarea { width: 100%; height: 300px; font-size: 16px; padding: 10px; margin-top: 10px; }
.chip-container { display: flex; flex-wrap: wrap; gap: 10px; }
.chip { padding: 12px 16px; border-radius: 25px; background-color: #f0f0f0; cursor: pointer; user-select: none; border: 1px solid #ccc; display: flex; align-items: center; justify-content: space-between; font-size: 16px; transition: all 0.2s ease; }
.chip.selected { background-color: #4caf50; color: white; border-color: #4caf50; font-weight: bold; }
.chip.selected::after { content: '✔'; font-size: 20px; margin-left: 8px; }
.autocomplete-suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; position: absolute; background: white; z-index: 1000; width: calc(100% - 22px); }
.autocomplete-suggestion { padding: 8px; cursor: pointer; }
.autocomplete-suggestion:hover { background-color: #ddd; }
</style>
</head>
<body>

<h1>Generador de Acceso</h1>

<label>Selecciona Sitio:</label>
<div style="position:relative;">
  <input type="text" id="sitioInput" placeholder="Escribe nombre del sitio">
  <div id="sitioSuggestions" class="autocomplete-suggestions"></div>
</div>

<label>Actividad:</label>
<select id="actividadSelect"></select>

<label>Vehículo:</label>
<select id="vehiculoSelect"></select>

<label>Técnico Principal:</label>
<select id="tecnicoPrincipalSelect"></select>

<label>Técnicos Adicionales:</label>
<div class="chip-container" id="tecnicosChipsDiv"></div>

<button id="generarBtn">Generar Mensaje</button>
<button id="copiarBtn">Copiar al Portapapeles</button>
<button id="whatsappBtn">Enviar a WhatsApp</button>

<textarea id="mensaje" readonly></textarea>

<script>
let sitios = [], actividades = [], tecnicos = [], vehiculos = [];
let seleccionAdicional = new Set();
let sitioSeleccionado = null;

// Cargar CSV
async function cargarCSV(nombreArchivo) {
  const res = await fetch(nombreArchivo);
  const texto = await res.text();
  const lines = texto.trim().split('\n');
  const headers = lines[0].split(';');
  return lines.slice(1).map(line=>{
    const values = line.split(';');
    const obj = {};
    headers.forEach((h,i)=>obj[h]=values[i]);
    return obj;
  });
}

// Inicializar
async function init() {
  sitios = await cargarCSV('sitios.csv');
  actividades = await cargarCSV('actividad.csv');
  tecnicos = await cargarCSV('tecnicos.csv');
  vehiculos = await cargarCSV('vehiculos.csv');

  // Actividades dropdown
  const actividadSelect = document.getElementById('actividadSelect');
  actividades.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a.Actividad;
    opt.textContent = a.Actividad;
    actividadSelect.appendChild(opt);
  });

  // Vehiculos dropdown
  const vehiculoSelect = document.getElementById('vehiculoSelect');
  vehiculos.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.Placa;
    opt.textContent = `${v.Placa} - ${v.Marca} ${v.Modelo} ${v.Color}`;
    vehiculoSelect.appendChild(opt);
  });

  // Tecnico principal
  const tecnicoPrincipalSelect = document.getElementById('tecnicoPrincipalSelect');
  tecnicos.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.TECNICO;
    opt.textContent = `${t.TECNICO} (${t.DUI})`;
    tecnicoPrincipalSelect.appendChild(opt);
  });

  renderChips();
}

// Autocomplete Sitios
const sitioInput = document.getElementById('sitioInput');
const suggestionBox = document.getElementById('sitioSuggestions');

sitioInput.addEventListener('input', ()=>{
  const val = sitioInput.value.toLowerCase();
  suggestionBox.innerHTML = '';
  if(!val) return;
  sitios.filter(s=>s['Nombre de Sitio'].toLowerCase().includes(val))
        .forEach(s=>{
    const div = document.createElement('div');
    div.className='autocomplete-suggestion';
    div.textContent = `${s['Nombre de Sitio']} (ID: ${s.SiteID})`;
    div.addEventListener('click', ()=>{
      sitioInput.value = s['Nombre de Sitio'];
      sitioSeleccionado = s;
      suggestionBox.innerHTML = '';
    });
    suggestionBox.appendChild(div);
  });
});

// Chips tecnicos adicionales
const tecnicosChipsDiv = document.getElementById('tecnicosChipsDiv');
const tecnicoPrincipalSelect = document.getElementById('tecnicoPrincipalSelect');

function renderChips() {
  tecnicosChipsDiv.innerHTML = '';
  tecnicos.forEach(t=>{
    if(t.TECNICO === tecnicoPrincipalSelect.value) return;
    const chip = document.createElement('div');
    chip.className='chip';
    chip.textContent=t.TECNICO;
    if(seleccionAdicional.has(t.TECNICO)) chip.classList.add('selected');
    chip.addEventListener('click', ()=>{
      if(seleccionAdicional.has(t.TECNICO)){
        seleccionAdicional.delete(t.TECNICO);
        chip.classList.remove('selected');
      } else {
        seleccionAdicional.add(t.TECNICO);
        chip.classList.add('selected');
      }
    });
    tecnicosChipsDiv.appendChild(chip);
  });
}

tecnicoPrincipalSelect.addEventListener('change', ()=>{
  if(seleccionAdicional.has(tecnicoPrincipalSelect.value)) seleccionAdicional.delete(tecnicoPrincipalSelect.value);
  renderChips();
});

// Generar mensaje
function generarMensaje() {
  if(!sitioSeleccionado) { alert('Selecciona un sitio válido'); return; }
  const actividad = document.getElementById('actividadSelect').value;
  const vehiculo = vehiculos.find(v=>v.Placa===document.getElementById('vehiculoSelect').value);
  const tecnicoPrincipal = tecnicos.find(t=>t.TECNICO===tecnicoPrincipalSelect.value);
  const tecnicosAdicionales = Array.from(seleccionAdicional).map(n=> tecnicos.find(t=>t.TECNICO===n));

  const bloqueTecnicos = [tecnicoPrincipal, ...tecnicosAdicionales].map(t=>`${t.TECNICO}\t${t.DUI} (${t['FECHA DE NACIMIENTO']})`).join('\n');

  const mensaje = `BUEN DIA
SU AYUDA CON EL SIGUIENTE ACCESO POR FAVOR :
▬▬▬▬▬▬▬▬▬▬
ID:${sitioSeleccionado.SiteID}
NOMBRE: ${sitioSeleccionado['Nombre de Sitio']}
PROPIETARIO: ${sitioSeleccionado.Torrero}
Nombre Torrero ${sitioSeleccionado['Nombre Torrero']}
▬▬▬▬▬▬▬▬▬▬
ACTIVIDAD: ${actividad}
▬▬▬▬▬▬▬▬▬▬
TECNICO PRINCIPAL/DUI
${bloqueTecnicos}
▬▬▬▬▬▬▬▬▬▬
Placa: ${vehiculo.Placa}
Marca: ${vehiculo.Marca}
Modelo: ${vehiculo.Modelo}
Color: ${vehiculo.Color}
▬▬▬▬▬▬▬▬▬▬
TELEFONO: ${tecnicoPrincipal.TELEFONO}
CORREO: ${tecnicoPrincipal.CORREO} tecnicossv@celectcac.com
`;

  document.getElementById('mensaje').value = mensaje;
}

// Botones
document.getElementById('generarBtn').addEventListener('click', generarMensaje);

document.getElementById('copiarBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('mensaje');
  txt.select();
  navigator.clipboard.writeText(txt.value);
  alert('Mensaje copiado al portapapeles');
});

document.getElementById('whatsappBtn').addEventListener('click', ()=>{
  const mensajeText = encodeURIComponent(document.getElementById('mensaje').value);
  window.open(`https://wa.me/?text=${mensajeText}`, '_blank');
});

init();
</script>
</body>
</html>



