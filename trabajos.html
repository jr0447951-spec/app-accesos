<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Mensajes MANTENIMIENTO</title>
<style>
  /* Fondo alegre pero suave */
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
    background: linear-gradient(135deg, #f0f4ff, #e0f7f1);
    min-height: 100vh;
  }
  h2 { margin-bottom: 15px; color: #333; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border-radius:5px; border:1px solid #ccc; }
  
  #listaSitios {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: white;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
  }

  .chip {
    display: inline-block;
    padding: 6px 12px;
    margin: 4px;
    background: #eee;
    border-radius: 25px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
  }
  .chip:hover { transform: scale(1.05); background: #ddd; }
  .chip.selected { background: #4CAF50; color: white; transform: scale(1.1) rotate(-2deg); }
  
  .chip.validacion { background: #f0c040; }
  .chip.validacion:hover { transform: scale(1.05); background:#f4d955; }
  .chip.validacion.selected { background: #FF9800; color: white; transform: scale(1.1) rotate(2deg); }

  button {
    margin-top: 15px;
    padding: 12px;
    width: 100%;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: #4CAF50;
    color: white;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  button:hover { background: #45a049; transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

  /* Vista previa */
  #vistaPrevia {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    min-height: 150px;
    white-space: pre-wrap;
    overflow-y: auto;
    margin-top:10px;
  }

  /* Mensaje de error */
  #errorMsg {
    color: red;
    font-weight: bold;
    margin-top: 10px;
    display: none;
  }
</style>
</head>
<body>

<h2>Generador de Mensajes MANTENIMIENTO</h2>

<label for="sitio">Sitio:</label>
<div style="position: relative;">
  <input type="text" id="sitio" placeholder="Escriba el sitio...">
  <div id="listaSitios"></div>
</div>

<label for="porte">Tipo de Porte:</label>
<select id="porte">
  <option value="">Seleccione un porte</option>
  <option value="GRAN">Gran Porte</option>
  <option value="MEDIANO">Mediano Porte</option>
  <option value="PEQUE√ëO">Peque√±o Porte</option>
</select>

<label>Reportes:</label>
<div id="reportes"></div>

<label>Trabajos realizados:</label>
<div id="trabajos"></div>

<label>Validaci√≥n:</label>
<div id="validacion"></div>

<label>Vista previa:</label>
<div id="vistaPrevia"></div>

<div id="errorMsg">Completa los datos para generar mensaje.</div>

<button id="generar">Generar y Copiar al Portapapeles</button>
<button id="whatsapp">Enviar por WhatsApp</button>

<script>
let sitios = [], reportes = [], trabajos = [];

// Cargar CSV
async function cargarCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  const lineas = text.trim().split('\n');
  const headers = lineas[0].split(';');
  return lineas.slice(1).map(l => {
    const cols = l.split(';');
    let obj = {};
    headers.forEach((h,i) => obj[h.trim()] = cols[i]?.trim());
    return obj;
  });
}

// Inicializaci√≥n
async function inicializar() {
  sitios = await cargarCSV('sitios.csv');
  reportes = await cargarCSV('reportes.csv');
  trabajos = await cargarCSV('trabajos.csv');

  // Mostrar todas las opciones al inicio
  actualizarReportes();
  actualizarTrabajos();
  
  document.getElementById('porte').addEventListener('change', () => {
    // YA NO FILTRAMOS, solo actualizamos la vista previa si el porte es parte del mensaje final (opcional)
    // actualizarReportes();  <-- COMENTADO
    // actualizarTrabajos();  <-- COMENTADO
    actualizarVistaPrevia();
  });

  // Crear chip √∫nico de validaci√≥n con emoji
  const divVal = document.getElementById('validacion');
  const chipVal = document.createElement('div');
  chipVal.className = 'chip validacion';
  chipVal.textContent = "‚úÖ Sitio Operativo, valida NOC ITS";
  chipVal.addEventListener('click', () => {
    divVal.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
    chipVal.classList.toggle('selected');
    actualizarVistaPrevia();
  });
  divVal.appendChild(chipVal);
}

// Actualizar reportes (AHORA MUESTRA TODOS SIN FILTRAR)
function actualizarReportes() {
  // const porte = document.getElementById('porte').value; <-- YA NO SE USA
  const divRep = document.getElementById('reportes');
  divRep.innerHTML = '';
  // if(!porte) return; <-- YA NO SE USA

  // Se muestran TODOS los reportes sin filtro
  reportes.forEach((r,i) => { 
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = "üìù " + r.CORTO;
    chip.dataset.index = i;
    chip.addEventListener('click', () => {
      chip.classList.toggle('selected');
      actualizarVistaPrevia();
    });
    divRep.appendChild(chip);
  });
}

// Actualizar trabajos (AHORA MUESTRA TODOS SIN FILTRAR)
function actualizarTrabajos() {
  // const porte = document.getElementById('porte').value; <-- YA NO SE USA
  const divTrabajos = document.getElementById('trabajos');
  divTrabajos.innerHTML = '';
  // if(!porte) return; <-- YA NO SE USA

  // Se muestran TODOS los trabajos sin filtro
  trabajos.forEach((t,i) => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = "üîß " + t.CORTO;
    chip.dataset.index = i;
    chip.addEventListener('click', () => {
      chip.classList.toggle('selected');
      actualizarVistaPrevia();
    });
    divTrabajos.appendChild(chip);
  });
}

// Autocompletado sitios
const inputSitio = document.getElementById('sitio');
const lista = document.getElementById('listaSitios');
inputSitio.addEventListener('input', () => {
  const val = inputSitio.value.toLowerCase();
  lista.innerHTML = '';
  if (!val) return;
  sitios.filter(s => s['Nombre de Sitio'].toLowerCase().includes(val))
    .forEach(s => {
      const div = document.createElement('div');
      div.textContent = `${s['Nombre de Sitio']} (${s.SiteID})`;
      div.style.padding='5px';
      div.style.cursor='pointer';
      div.addEventListener('click', () => {
        inputSitio.value = s['Nombre de Sitio'];
        inputSitio.dataset.siteid = s.SiteID;
        lista.innerHTML = '';
        actualizarVistaPrevia();
      });
      lista.appendChild(div);
    });
});
document.addEventListener('click', e => {
  if(!inputSitio.contains(e.target) && !lista.contains(e.target)) lista.innerHTML='';
});

// Funci√≥n para elegir variante aleatoria de trabajo
function obtenerTextoAleatorio(trabajo) {
  const variantes = [trabajo.VARIANTE1, trabajo.VARIANTE2, trabajo.VARIANTE3].filter(Boolean);
  return variantes[Math.floor(Math.random() * variantes.length)];
}

// Generar mensaje
function generarMensaje() {
  const sitioNombre = inputSitio.value || '';
  const sitioID = inputSitio.dataset.siteid || '';
  const porte = document.getElementById('porte').value;
  let mensajeBase = "Mantenimiento preventivo finalizado.";

  // Ahora se pueden seleccionar de la lista completa
  const repSeleccionados = Array.from(document.querySelectorAll('#reportes .chip.selected'))
    .map(c => reportes[c.dataset.index].DETALLADO);
  
  // Ahora se pueden seleccionar de la lista completa
  const trabajosSeleccionados = Array.from(document.querySelectorAll('#trabajos .chip.selected'))
    .map(c => obtenerTextoAleatorio(trabajos[c.dataset.index]));

  const valSeleccionada = document.querySelector('#validacion .chip.selected');
  const valTexto = valSeleccionada ? valSeleccionada.textContent : '';

  // IMPORTANTE: Ahora el mensaje se genera aunque no se haya seleccionado porte.
  // Se elimina la condici√≥n: if(!sitioNombre || !porte) return null;
  if(!sitioNombre) return null;

  let msg = `${sitioNombre}\nID: ${sitioID}\n\n${mensajeBase}\n`;
  if(repSeleccionados.length) msg += `\nSe realizaron los siguientes reportes:\n‚Ä¢ ${repSeleccionados.join('\n‚Ä¢ ')}\n`;
  if(trabajosSeleccionados.length) msg += `\n${trabajosSeleccionados.join('\n')}\n`;
  if(valTexto) msg += `\n${valTexto}`;
  return msg;
}

// Actualizar vista previa
function actualizarVistaPrevia() {
  const msg = generarMensaje();
  const vista = document.getElementById('vistaPrevia');
  const error = document.getElementById('errorMsg');
  if(msg) {
    vista.textContent = msg;
    error.style.display = 'none';
  } else {
    vista.textContent = '';
    error.style.display = 'block';
  }
}

// Botones
document.getElementById('generar').addEventListener('click', () => {
  const msg = generarMensaje();
  if(!msg) { document.getElementById('errorMsg').style.display='block'; return; }
  navigator.clipboard.writeText(msg).then(() => alert('Copiado al portapapeles'));
});
document.getElementById('whatsapp').addEventListener('click', () => {
  const msg = generarMensaje();
  if(!msg) { document.getElementById('errorMsg').style.display='block'; return; }
  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
});

inicializar();
</script>
</body>
</html>
